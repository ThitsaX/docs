
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Mojaloop platform documentation">
      
      
      
        <link rel="canonical" href="https://docs.thitsaworks.com/latest/deploy-payment-manager-on-premise/">
      
      
      
      
        
      
      
      <link rel="icon" href="../assets/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>üè¢ Payment Manager for Mojaloop (PM4ML) - ThitsaWorks Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#payment-manager-for-mojaloop-pm4ml" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ThitsaWorks Documentation" class="md-header__button md-logo" aria-label="ThitsaWorks Documentation" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ThitsaWorks Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              üè¢ Payment Manager for Mojaloop (PM4ML)
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ThitsaWorks Documentation" class="md-nav__button md-logo" aria-label="ThitsaWorks Documentation" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    ThitsaWorks Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Architecture
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../platform-architecture-overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Platform Architecture Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Security
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Security
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hub-pm4ml-security-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hub ‚Üî PM4ML
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Deployment
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Deployment
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deploy-mojaloop-local-microk8s/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploy Mojaloop Locally (MicroK8s)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deploy-mojaloop-local-withoutk8s/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploy Mojaloop Locally (Without Kubernetes)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#production-deployment-guide-on-premise" class="md-nav__link">
    <span class="md-ellipsis">
      
        Production Deployment Guide (On-Premise)
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="payment-manager-for-mojaloop-pm4ml">üè¢ Payment Manager for Mojaloop (PM4ML)</h1>
<h2 id="production-deployment-guide-on-premise">Production Deployment Guide (On-Premise)</h2>
<p>This document provides step-by-step guidance for deploying <strong>Payment Manager for Mojaloop (PM4ML)</strong> in an on-premise data center environment using:</p>
<ul>
<li>Ubuntu 24.04 LTS</li>
<li>MicroK8s (Kubernetes)</li>
<li>Ansible</li>
<li>GitOps with Argo CD</li>
<li>HAProxy (External &amp; Internal Load Balancer)</li>
<li>WireGuard VPN (Optional)</li>
</ul>
<hr />
<h1 id="code-base-reference">üì¶ Code Base Reference</h1>
<p>This deployment architecture is derived from the official Mojaloop Infrastructure as Code (IaC) modules:</p>
<p><a href="https://github.com/mojaloop/iac-modules">https://github.com/mojaloop/iac-modules</a></p>
<p>The original AWS-focused implementation has been adapted and extended to support on-premise infrastructure using MicroK8s, HAProxy, and GitOps-based workflows.</p>
<hr />
<h1 id="pm4ml-on-premise-architecture-overview">üèó PM4ML On-Premise Architecture Overview</h1>
<p>The following diagram illustrates the logical and network architecture of the PM4ML on-premise deployment.</p>
<h2 id="logical-architecture-view">Logical Architecture View</h2>
<p><img width="1427" height="906" alt="image" src="https://github.com/user-attachments/assets/4d244515-a0f3-47ef-b878-663da6c894c9" /></p>
<h2 id="network-architecture-view">Network Architecture View</h2>
<p><img width="746" height="636" alt="image" src="https://github.com/user-attachments/assets/d48490fd-e95c-4956-9b8d-293f17af03d0" /></p>
<hr />
<h1 id="1-prerequisites">1. Prerequisites</h1>
<h2 id="11-infrastructure-requirements-production-recommended">1.1 Infrastructure Requirements (Production Recommended)</h2>
<table>
<thead>
<tr>
<th>Component</th>
<th>Count</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>HAProxy</td>
<td>1‚Äì2</td>
<td>Public &amp; Private ingress load balancer</td>
</tr>
<tr>
<td>MicroK8s Master Nodes</td>
<td>3</td>
<td>Kubernetes control plane</td>
</tr>
<tr>
<td>Worker Nodes</td>
<td>3+</td>
<td>Application workloads</td>
</tr>
<tr>
<td>Storage Server (Ceph)</td>
<td>3+</td>
<td>Cold storage</td>
</tr>
<tr>
<td>Bastion Host (Optional)</td>
<td>1</td>
<td>Secure administrative access</td>
</tr>
<tr>
<td>NAT Gateway (Optional)</td>
<td>1</td>
<td>Outbound internet for private subnet</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="12-network-requirements">1.2 Network Requirements</h2>
<ul>
<li>Static IP address for each VM</li>
<li>Internal subnet (e.g., <code>10.10.0.0/16</code>)</li>
<li>Public IP mapped to HAProxy via firewall</li>
<li>DNS zone (AWS, Cloudflare, or enterprise DNS)</li>
</ul>
<h3 id="required-ports">Required Ports</h3>
<table>
<thead>
<tr>
<th>Port</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>22</td>
<td>SSH</td>
</tr>
<tr>
<td>80</td>
<td>HTTP</td>
</tr>
<tr>
<td>443</td>
<td>HTTPS</td>
</tr>
<tr>
<td>WireGuard Port</td>
<td>VPN (if enabled)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="13-storage-requirements">1.3 Storage Requirements</h2>
<ul>
<li>Ceph RBD / CephFS</li>
<li>S3-compatible storage</li>
</ul>
<hr />
<h1 id="2-tools-versions">2. Tools &amp; Versions</h1>
<table>
<thead>
<tr>
<th>Tool</th>
<th>Version</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ubuntu</td>
<td>24.04 LTS</td>
</tr>
<tr>
<td>MicroK8s</td>
<td>1.31/stable</td>
</tr>
<tr>
<td>Ansible</td>
<td>2.18+</td>
</tr>
<tr>
<td>Helm</td>
<td>v3</td>
</tr>
<tr>
<td>kubectl</td>
<td>Matching cluster version</td>
</tr>
<tr>
<td>Git</td>
<td>Latest stable</td>
</tr>
</tbody>
</table>
<hr />
<h1 id="3-vm-provisioning">3. VM Provisioning</h1>
<p>VMs may be provisioned using:</p>
<ul>
<li>VMware</li>
<li>Proxmox</li>
<li>OpenStack</li>
<li>CloudStack</li>
<li>Bare Metal</li>
</ul>
<hr />
<h1 id="4-infrastructure-sizing-by-environment">4. Infrastructure Sizing by Environment</h1>
<h2 id="41-production-environment-prod">4.1 Production Environment (PROD)</h2>
<h3 id="recommended-production-infrastructure-sizing">Recommended Production Infrastructure Sizing</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Quantity</th>
<th>CPU / RAM / Storage (Per Server)</th>
<th>Deployment Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master Node Cluster</td>
<td>√ó3 Servers</td>
<td>8 CPU Cores, 32 GB RAM, 2 √ó 300 GB NVMe</td>
<td>VM</td>
<td>Dedicated control plane nodes</td>
</tr>
<tr>
<td>Worker Node Cluster</td>
<td>√ó3 Servers</td>
<td>16 CPU Cores, 64 GB RAM, 2 √ó 500 GB NVMe</td>
<td>VM</td>
<td>Application workloads only</td>
</tr>
<tr>
<td>Load Balancers (HAProxy)</td>
<td>√ó2 Servers</td>
<td>4 CPU Cores, 16 GB RAM, 100 GB SSD</td>
<td>VM</td>
<td>Active/Active or Active/Standby</td>
</tr>
<tr>
<td>Cold Data Storage Cluster</td>
<td>√ó3 Servers</td>
<td>16 CPU Cores, 64 GB RAM; OS: 2 √ó 500 GB SSD (RAID1); Data: 6 √ó 8 TB HDD; Network: 2 √ó 10 Gbps</td>
<td>Physical</td>
<td>Enterprise storage</td>
</tr>
</tbody>
</table>
<h3 id="cold-storage-purpose">Cold Storage Purpose</h3>
<p>Cold storage devices are intended exclusively for:</p>
<ul>
<li>Long-term regulatory record retention</li>
<li>Backup archives</li>
<li>Ledger export snapshots</li>
<li>Log archival storage</li>
</ul>
<p>Cold storage must not be used for latency-sensitive transaction processing workloads.</p>
<hr />
<h2 id="42-staging-environment-stg">4.2 Staging Environment (STG)</h2>
<p>Designed for:</p>
<ul>
<li>Functional testing</li>
<li>Integration testing</li>
<li>Performance validation</li>
<li>Pre-production validation</li>
</ul>
<h3 id="recommended-staging-infrastructure-sizing">Recommended Staging Infrastructure Sizing</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Quantity</th>
<th>CPU / RAM / Storage (Per Server)</th>
<th>Deployment Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master Node Cluster</td>
<td>√ó3 Servers</td>
<td>4 CPU Cores, 16 GB RAM, 200 GB SSD</td>
<td>VM</td>
<td>Control plane</td>
</tr>
<tr>
<td>Worker Node Cluster</td>
<td>√ó2 Servers</td>
<td>8 CPU Cores, 32 GB RAM, 300 GB SSD</td>
<td>VM</td>
<td>Application workloads</td>
</tr>
<tr>
<td>Load Balancer (HAProxy)</td>
<td>√ó1 Server</td>
<td>2 CPU Cores, 8 GB RAM, 50 GB SSD</td>
<td>VM</td>
<td>Single instance</td>
</tr>
<tr>
<td>Cold Storage</td>
<td>Optional</td>
<td>Reduced capacity</td>
<td>VM or Shared Storage</td>
<td>Optional</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="43-environment-policy">4.3 Environment Policy</h2>
<ul>
<li>Production must use dedicated control plane nodes</li>
<li>Production must maintain high availability</li>
<li>Staging may operate with reduced redundancy</li>
<li>Any deviation from Production requirements must be formally approved</li>
</ul>
<hr />
<h2 id="44-master-and-worker-on-same-node-risk-acceptance">4.4 Master and Worker on Same Node (Risk Acceptance)</h2>
<p>Combining control plane and worker workloads is technically possible but not recommended for production.</p>
<p>Risks:</p>
<ul>
<li>Resource contention</li>
<li>Reduced stability under load</li>
<li>Increased blast radius</li>
<li>Difficult capacity planning</li>
<li>Potential Kubernetes API impact</li>
</ul>
<p>Production recommendation:</p>
<ul>
<li>3 dedicated master nodes</li>
<li>Workloads only on worker nodes</li>
<li>No scheduling on control plane nodes</li>
</ul>
<p>If combined, formal risk acceptance is required.</p>
<hr />
<h1 id="5-haproxy-configuration-on-premise">5. HAProxy Configuration (On-Premise)</h1>
<h2 id="51-overview">5.1 Overview</h2>
<p>HAProxy acts as the ingress load-balancing layer in front of the MicroK8s cluster.</p>
<p>Architecture:</p>
<pre><code>Client ‚Üí Perimeter Firewall ‚Üí HAProxy ‚Üí Istio Ingress Gateway ‚Üí PM4ML Services
</code></pre>
<hr />
<h2 id="52-architecture-components">5.2 Architecture Components</h2>
<h3 id="perimeter-firewall">Perimeter Firewall</h3>
<ul>
<li>First security boundary</li>
<li>Filters inbound traffic</li>
<li>May perform NAT</li>
<li>Centralized logging</li>
</ul>
<h3 id="haproxy">HAProxy</h3>
<ul>
<li>Layer 4 (TCP) load balancing</li>
<li>Forwards traffic to Kubernetes nodes</li>
<li>Does not terminate TLS</li>
</ul>
<h3 id="istio-ingress-gateway">Istio Ingress Gateway</h3>
<ul>
<li>Terminates TLS</li>
<li>Applies routing policies</li>
<li>Enforces service mesh security</li>
<li>Routes traffic to PM4ML</li>
</ul>
<hr />
<h2 id="53-haproxy-interfaces">5.3 HAProxy Interfaces</h2>
<table>
<thead>
<tr>
<th>Interface</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Public</td>
<td>Receives traffic from firewall</td>
</tr>
<tr>
<td>Private</td>
<td>Forwards traffic to Kubernetes</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="54-tls-termination-strategy">5.4 TLS Termination Strategy</h2>
<p>TLS termination occurs at Istio Ingress Gateway.</p>
<p>Benefits:</p>
<ul>
<li>Centralized certificate lifecycle management</li>
<li>Better integration with service mesh policies</li>
<li>Improved observability</li>
<li>Reduced HAProxy complexity</li>
</ul>
<hr />
<h2 id="55-high-availability">5.5 High Availability</h2>
<ul>
<li>Two HAProxy nodes (Production)</li>
<li>Firewall-level failover or VIP</li>
<li>Separate physical hosts where possible</li>
</ul>
<hr />
<h2 id="56-security-controls">5.6 Security Controls</h2>
<ul>
<li>Expose only required ports (typically 443)</li>
<li>Restrict SSH access</li>
<li>Apply host-level firewall rules</li>
<li>Integrate logs into monitoring/SIEM</li>
</ul>
<hr />
<h2 id="57-public-and-private-ip-requirements">5.7 Public and Private IP Requirements</h2>
<h3 id="public-ip">Public IP</h3>
<ul>
<li>Assigned at firewall layer</li>
<li>NAT to HAProxy private IP</li>
<li>Minimum: 1 Public IP</li>
<li>Recommended: 1 Public VIP</li>
</ul>
<p>Example:</p>
<pre><code>Internet ‚Üí Firewall ‚Üí NAT ‚Üí HAProxy ‚Üí Istio ‚Üí Services
</code></pre>
<h3 id="private-ip">Private IP</h3>
<p>Required for:</p>
<ul>
<li>HAProxy</li>
<li>Kubernetes Masters</li>
<li>Kubernetes Workers</li>
<li>Storage Cluster</li>
<li>Bastion Host</li>
</ul>
<hr />
<h1 id="6-gitops-deployment">6. GitOps Deployment</h1>
<h2 id="61-platform-applications-deployment-order">6.1 Platform Applications Deployment Order</h2>
<p>Argo CD applications must be deployed in the following sequence to satisfy dependencies and ensure system stability.</p>
<ol>
<li>
<p>Base Utilities</p>
</li>
<li>
<p><code>base-utils</code></p>
</li>
<li>
<p>Storage Layer</p>
</li>
<li>
<p><code>storage-app</code></p>
</li>
<li>
<p>Certificate Management</p>
</li>
<li>
<p><code>certmanager-helm</code></p>
</li>
<li><code>certmanager-app</code></li>
<li>
<p><code>certmanager-clusterissuers</code></p>
</li>
<li>
<p>Service Mesh</p>
</li>
<li>
<p><code>istio-app</code></p>
</li>
<li><code>istio-main-app</code></li>
<li>
<p><code>istio-gateways-app</code></p>
</li>
<li>
<p>DNS Management</p>
</li>
<li>
<p><code>external-dns-app</code></p>
</li>
<li>
<p>Vault Storage Backend</p>
</li>
<li>
<p><code>consul-app</code></p>
</li>
<li>
<p>Vault &amp; Secrets Management</p>
</li>
<li>
<p><code>vault-app</code></p>
</li>
<li><code>vault</code></li>
<li><code>vault-config-operator</code></li>
<li>
<p><code>vault-pki-app</code></p>
</li>
<li>
<p>Stateful Resources</p>
</li>
<li>
<p><code>stateful-resources-operators-app</code></p>
</li>
<li>
<p><code>common-stateful-resources-app</code></p>
</li>
<li>
<p>Monitoring Stack</p>
</li>
<li>
<p><code>monitoring-app</code></p>
</li>
<li><code>monitoring-install</code></li>
<li>
<p><code>monitoring-post-config</code></p>
</li>
<li>
<p>Identity &amp; Access Management</p>
</li>
<li>
<p><code>keycloak-app</code></p>
</li>
<li><code>keycloak-install</code></li>
<li><code>keycloak-post-config</code></li>
<li>
<p><code>ory-app</code></p>
</li>
<li>
<p>PM4ML Core</p>
</li>
<li>
<p><code>pm4ml</code></p>
</li>
</ol>
<hr />
<h2 id="62-clone-repository">6.2 Clone Repository</h2>
<pre><code class="language-bash">git clone &lt;your-onprem-gitops-repo&gt;
cd &lt;repo&gt;
</code></pre>
<hr />
<h2 id="63-update-configuration">6.3 Update Configuration</h2>
<h3 id="ansibleinventoryini">ansible/inventory.ini</h3>
<pre><code class="language-ini">[cluster]
node1 ansible_host=10.x.x.x role=master
node2 ansible_host=10.x.x.x role=master
node3 ansible_host=10.x.x.x role=master
node4 ansible_host=10.x.x.x role=worker
node5 ansible_host=10.x.x.x role=worker
node6 ansible_host=10.x.x.x role=worker
;if you want both master and worker in one single node remove the role

[haproxy]
haproxy ansible_host=10.x.x.x ext_haproxy_ip=13.x.x.x int_haproxy_ip=10.x.x.x 

[ceph]
node1 ansible_host=10.x.x.x
node2 ansible_host=10.x.x.x
node3 ansible_host=10.x.x.x

[all:vars]
ansible_user=ubuntu
ansible_ssh_private_key_file=~/&lt;sshkeyname&gt;
ansible_ssh_common_args='-o StrictHostKeyChecking=no'
</code></pre>
<hr />
<h3 id="ansiblegroup_varsallyml">ansible/group_vars/all.yml</h3>
<pre><code class="language-yaml">microk8s_version : &quot;1.31/stable&quot;
git_url: &quot;https://&lt;your gitops repo&gt;.git&quot;
git_branch: &quot;&lt;user main branch or tag&gt;&quot;
git_user: &quot;&lt;git username&gt;&quot;
git_password: &quot;&lt;git password or toen&gt;&quot;
nic_iface: &lt;eth0&gt;
</code></pre>
<p>Update:</p>
<ul>
<li>DNS configurations</li>
<li>URLs</li>
<li>S3 bucket configurations</li>
<li>PM4ML configurations</li>
</ul>
<hr />
<h2 id="64-run-ansible-playbooks">6.4 Run Ansible Playbooks</h2>
<pre><code class="language-bash">ansible-playbook -i inventory.ini 1.microk8s_setup.yml
ansible-playbook -i inventory.ini 2.argocd_setup.yml
ansible-playbook -i inventory.ini 3.haproxy_setup.yml
ansible-playbook -i inventory.ini 4.ceph.yml
ansible-playbook -i inventory.ini 5.apps_setup.yml
ansible-playbook -i inventory.ini 6.system-tuning.yml
</code></pre>
<hr />
<h1 id="7-storage-configuration-changes">7. Storage Configuration Changes</h1>
<h2 id="71-longhorn-backup-nfs-example">7.1 Longhorn Backup (NFS Example)</h2>
<pre><code class="language-yaml">backupTarget: &quot;nfs://10.10.0.50:/longhorn-backup&quot;
</code></pre>
<h2 id="72-loki-configuration">7.2 Loki Configuration</h2>
<pre><code class="language-yaml">loki:
  storage:
    type: filesystem
    filesystem:
      directory: /var/loki
</code></pre>
<h2 id="73-tempo-configuration">7.3 Tempo Configuration</h2>
<pre><code class="language-yaml">tempo:
  storage:
    trace:
      backend: local
      local:
        path: /var/tempo
</code></pre>
<hr />
<h1 id="8-certificate-management">8. Certificate Management</h1>
<h3 id="option-a-public-domain-http01">Option A ‚Äì Public Domain (HTTP01)</h3>
<p>Use HTTP challenge if publicly reachable.</p>
<h3 id="option-b-internal-ca">Option B ‚Äì Internal CA</h3>
<p>Use:</p>
<ul>
<li>Vault PKI</li>
<li>Corporate CA</li>
</ul>
<p>Remove Route53 DNS01 solver configuration.</p>
<hr />
<h1 id="9-dns-configuration">9. DNS Configuration</h1>
<p>Create A records:</p>
<pre><code>argocd.prod-pm4ml.domain.com ‚Üí External HAProxy IP
wallet1.prod-pm4ml.domain.com ‚Üí External HAProxy IP
</code></pre>
<hr />
<h1 id="10-vault-configuration">10. Vault Configuration</h1>
<ul>
<li>Use Integrated Storage (Raft)</li>
<li>Disable AWS KMS auto-unseal</li>
<li>Configure Vault PKI</li>
<li>Enable Kubernetes Auth</li>
</ul>
<hr />
<h1 id="11-monitoring-stack-adjustments">11. Monitoring Stack Adjustments</h1>
<p>Replace:</p>
<ul>
<li>S3-backed Loki</li>
<li>S3-backed Tempo</li>
</ul>
<p>With:</p>
<ul>
<li>NFS</li>
<li>Ceph</li>
<li>MinIO (optional)</li>
</ul>
<p>Update:</p>
<ul>
<li><code>values-loki.yaml</code></li>
<li><code>values-tempo.yaml</code></li>
</ul>
<hr />
<h1 id="12-manual-secret-sync-hub-pm4ml">12. Manual Secret Sync (Hub ‚Üí PM4ML)</h1>
<p>Request client secret from Hub operator.</p>
<p>Create secret in Vault:</p>
<pre><code>secret/&lt;yourpm4ml_id&gt;
</code></pre>
<p>Key:</p>
<pre><code>mcmdev_client_secret
</code></pre>
<p>Value:</p>
<pre><code>secret_key_from_hub_operator
</code></pre>
<hr />
<h1 id="13-verification">13. Verification</h1>
<h2 id="verify-cluster">Verify Cluster</h2>
<pre><code class="language-bash">kubectl get nodes
</code></pre>
<h2 id="verify-argo-cd-applications">Verify Argo CD Applications</h2>
<pre><code class="language-bash">kubectl get app -A
</code></pre>
<h2 id="verify-haproxy">Verify HAProxy</h2>
<pre><code class="language-bash">systemctl status haproxy
</code></pre>
<hr />












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.sections", "navigation.top", "search.highlight", "search.suggest", "navigation.instant", "content.tabs.link", "navigation.footer", "header.autohide", "navigation.expand", "content.code.copy"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>